<!DOCTYPE html>
<html>
<head>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=drawing&key=AIzaSyAro0psoaV4dA4AkTSUm7TXt_bO9Nf1sB4"></script>

<title>Cinema profile</title>
</head>
<script src="js/user_types.js"></script>
<script src="js/projection_add.js"></script>
<script type="text/javascript">

	var halls = [];
	var cin_id = -1;
	var projections = [];
	var actors_count = 0;
	var halls_count = 0;
	
	function fill_map(div_id, lat, lng){
		var mapCanvas = document.getElementById(div_id);
	    var mapOptions = {
	        center: new google.maps.LatLng(lat, lng),
	        zoom: 15
	    };
	    var map = new google.maps.Map(mapCanvas, mapOptions);
	}
	
	function getMap(div_id, loc){
	
	    $.ajax({
				type : 'GET',
				url : 'https://maps.googleapis.com/maps/api/geocode/json?address=' + loc,
				
				success : function(data){
					if(data.results[0] == null){
						var lat = 1000;
						var lng = 1000;
					}else{
						
					var lat = data.results[0].geometry.location.lat;
					var lng = data.results[0].geometry.location.lng;
					}
	        	fill_map(div_id, lat, lng);
				},
				error : function(XMLHttpRequest, textStatus, errorThrown){
					alert("AJAX ERROR: " + errorThrown);
				}
			});
	}
	
	function render_cinema(cinema){
		halls = cinema.halls;
		cin_id = cinema.id;
		$('#details').append(cinema.name+"<br/>"+cinema.description+"<br/>"+cinema.address);
		if (cinema.isCinema){
			$('#image_and_map').append('<img src="resources/images/cinema.jpg" alt="Cinema" style="width:100%; height: 240px">');
			
		}else{
			$('#image_and_map').append('<img src="resources/images/theatre.jpg" alt="Theatre" style="width:100%; height: 240px">');
			
		}
		var html_string = '<div id="map" style="width:100%;height:250px;"></div>';
		$('#image_and_map').append(html_string);
		getMap("map", cinema.address);
		
		$.each(cinema.halls, function(index, hall){
			$('#sel1').append('<option>'+hall.hall_id+'</option>');
			$('#m_sel1').append('<option>'+hall.hall_id+'</option>');
		});
		
		$('#details').append('<button type="button" class="btn" data-toggle="modal" data-target="#modal_modify_cinema">Modify</button>')
		
		$('#m_cinema_name').val(cinema.name);
		$('#m_cinema_address').val(cinema.address);
		$('#m_cinema_description').val(cinema.description);
		
	}

	function get_cinema_data(){
		var id = window.location.search.substring(1);
		
		$.ajax({
			type : 'GET',
			url : 'http://localhost:8080/get_cinema?id=' + id,
			
			dataType : "json", // data type of response
			success : render_cinema
		});
	}
	
	function render_projections(data){
		var list = data == null ? [] : (data instanceof Array ? data : [ data ]);
		$.each(list, function(index, proj){
			if (cin_id == proj.cinthe_id){
				projections.push(proj);
				var proj_html = '<div id="proj_'+index+'" style="border:1px solid grey"><img id="proj_'+index+'_poster" src="'+proj.poster+'" alt="Projection_image" '+
						'style="width: 100px; height: 100px; float: right"><b id="proj_'+index+'_name">'+proj.name+'</b><p id="proj_'+index+'_description">'+proj.description+
						'</p><b id="proj_'+index+'_genre">'+proj.genre+'</b>,<p id="proj_'+index+'_director">'+proj.director+'</p><br/>'+proj.price+'<div class="float-right">'+
						'<button type="button" class="btn btn-primary" onclick="modify_projection('+index+')">Modify</button>'+
						'<button type="button" class="btn btn-primary" onclick="delete_projection('+index+')">Delete</button></div></div>'
				$('#repertoire').append(proj_html);
			}
		});
		
	}
	
	function get_projections(){
		$.ajax({
			type : 'GET',
			url : 'http://localhost:8080/get_projections',
			dataType : "json",
			success : render_projections,
		});
	}
	
	function actorsAdd(modal_check){
		var actor_name = $('#'+modal_check+'actor').val();
		$('#'+modal_check+'actors').append('<tr><td id="'+modal_check+'actor'+actors_count+'">'+actor_name+'</td><button type="button" class="btn">Remove</button></tr>');
		actors_count++;
	}
	
	function hallsAdd(modal_check){
		var hall = $('#'+modal_check+'sel1').val();
		$('#'+modal_check+'halls').append('<tr><td id="'+modal_check+'hall'+halls_count+'">'+hall+'</td></tr>');
		var time_html = '<div class="form-group"><label for="time'+halls_count+'" class="col-form-label">'+
					'Time of projection:</label><input type="time" class="form-control" id="time'+halls_count+'"></div>';
		$('#'+modal_check+'halls').append(time_html);
		halls_count++;
	}
	
	get_cinema_data();
	get_projections();
</script>
<body>
	<nav class="navbar navbar-inverse">
	  <div class="container-fluid">
	    <div class="navbar-header">
	      <a class="navbar-brand" href="/">Movies and cinemas</a>
	    </div>
	    <ul class="nav navbar-nav navbar-right" id="navbarRight">
	    </ul>
	  </div>
	</nav>
	<div class="container">
		<div class="row">
			<div class="col-md-4" id="image_and_map"></div>
			<div class="col-md-8">
				<ul class="nav nav-tabs">
				  <li class="active"><a data-toggle="pill" href="#details">Details</a></li>
				  <li><a data-toggle="pill" href="#repertoire">Repertoire</a></li>
				  <li><a data-toggle="pill" href="#discounts">Discounts</a></li>
				</ul>
				<div class="tab-content">
				  <div class="tab-pane fade in active" id="details">
				  </div>
				  <div class="tab-pane fade" id="repertoire">
				  	 <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addProjectionModal">Add new projection</button>
				  	
				  </div>
				  <div class="tab-pane fade" id="discounts">
				  </div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="addProjectionModal" tabindex="-1" role="dialog" aria-labelledby="addProjectionModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="addProjectionModalLabel">Add new projection</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        <form role="form" id="add_projection_form" method="POST">
	          <div class="form-group">
	            <label for="name" class="col-form-label">Name:</label>
	            <input type="text" class="form-control" id="name" required>
	          </div>
	          <div class="form-group">
				<label for="cinema_rows">Add actor</label> 
				<input type="text" class="form-control" id="actor">
				<button type="button" class="btn btn-primary" onclick="actorsAdd('')">Add actor</button>
				<div class="form-group">
					<table class="table">
					<thead><tr><th>Actors</th></tr></thead>
					<tbody id="actors">
					</tbody>
					</table>
				</div>
	          </div>
	          <div class="form-group">
	            <label for="genre" class="col-form-label">Genre:</label>
	            <input type="text" class="form-control" id="genre" required>
	          </div>
	          <div class="form-group">
	            <label for="director" class="col-form-label">Director:</label>
	            <input type="text" class="form-control" id="director" required>
	          </div>
	          <div class="form-group">
	            <label for="length" class="col-form-label">Length (hours):</label>
	            <input type="number" class="form-control" id="length" required>
	          </div>
	          <div class="form-group">
	            <label for="poster">Projection poster</label> 
	            <input type="file" class="form-control-file" id="poster">
	          </div>
	          <div class="form-group">
	            <label for="description" class="col-form-label">Description:</label>
	            <textarea class="form-control" id="description" required></textarea>
	          </div>
	          <div class="form-group">
			      <label for="sel1">Select hall (select one):</label>
			      <select class="form-control" id="sel1">
			      </select>
			      <button type="button" class="btn btn-primary" onclick="hallsAdd('')">Add hall</button>
				  <div class="form-group">
					<table class="table">
					<thead><tr><th>Halls</th></tr></thead>
					<tbody id="halls">
					</tbody>
					</table>
  				  </div>
			  </div>
			  <div class="form-group">
	            <label for="price" class="col-form-label">Price (RSD):</label>
	            <input type="number" class="form-control" id="price" required>
	          </div>
	          <button class="btn btn-primary">Confirm</button>
	          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
	        </form>
	      </div>
	    </div>
	  </div>
	</div>
	
	<div class="modal fade" id="modifyModal" tabindex="-1" role="dialog" aria-labelledby="modifyModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="modifyLabel">Modify projection</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        <form role="form" id="modify_form" method="POST">
	 		  <p id="m_id" hidden></p>
	          <div class="form-group">
	            <label for="name" class="col-form-label">Name:</label>
	            <input type="text" class="form-control" id="m_name" required>
	          </div>
	          <div class="form-group">
				<label for="cinema_rows">Add actor</label> 
				<input type="text" class="form-control" id="m_actor">
				<button type="button" class="btn btn-primary" onclick="actorsAdd('m_')">Add actor</button>
				<div class="form-group">
					<table class="table">
					<thead><tr><th>Actors</th></tr></thead>
					<tbody id="m_actors">
					</tbody>
					</table>
				</div>
	          </div>
	          <div class="form-group">
	            <label for="genre" class="col-form-label">Genre:</label>
	            <input type="text" class="form-control" id="m_genre" required>
	          </div>
	          <div class="form-group">
	            <label for="director" class="col-form-label">Director:</label>
	            <input type="text" class="form-control" id="m_director" required>
	          </div>
	          <div class="form-group">
	            <label for="length" class="col-form-label">Length (hours):</label>
	            <input type="number" class="form-control" id="m_length" required>
	          </div>
	          <div class="form-group">
	            <label for="poster">Projection poster</label> 
	            <input type="file" class="form-control-file" id="m_poster">
	          </div>
	          <div class="form-group">
	            <label for="description" class="col-form-label">Description:</label>
	            <textarea class="form-control" id="m_description" required></textarea>
	          </div>
	          <div class="form-group">
			      <label for="sel1">Select hall (select one):</label>
			      <select class="form-control" id="m_sel1">
			      </select>
			      <button type="button" class="btn btn-primary" onclick="hallsAdd('m_')">Add hall</button>
				  <div class="form-group">
					<table class="table">
					<thead><tr><th>Halls</th></tr></thead>
					<tbody id="m_halls">
					</tbody>
					</table>
  				  </div>
			  </div>
			  <div class="form-group">
	            <label for="price" class="col-form-label">Price (RSD):</label>
	            <input type="number" class="form-control" id="m_price" required>
	          </div>
	          <input type="text" id='m_id' hidden />
	          <button class="btn btn-primary">Confirm</button>
	          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
	        </form>
	      </div>
	    </div>
	  </div>
	</div>

	<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="deleteModalLabel">Delete projection</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">Are you sure you want to delete this projection?
	      	<p id="del_proj_id" hidden></p>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-primary" id="delete_proj_btn">Yes</button>
	        <button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
	      </div>
	    </div>
	  </div>
	</div>

	<div id="modal_modify_cinema" class="modal fade" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content">
				<div class="modal-body">
					<h3>Modify Cinema/Theatre</h3>
					<form role="form" id="add_cinema_form" method="POST">
						<div class="form-group">
							<label for="cinema_name">Name</label> <input type="text"
								class="form-control" id="m_cinema_name" required />
						</div>
						<div class="form-group">
							<label for="cinema_address">Address</label> <input type="text"
								class="form-control" id="m_cinema_address" required />
						</div>
						<div class="form-group">
							<label for="cinema_description">Description</label>
							<textarea class="form-control" rows="3" id="m_cinema_description"
								required></textarea>
						</div>
						<div class="form-group">
							<label for="is_cinema_radio">Type</label>
							<div class="radio">
								<label><input type="radio" name="is_cinema_radio"
									value="true" checked="checked">Cinema</label>
							</div>
							<div class="radio">
								<label><input type="radio" name="is_cinema_radio"
									value="false">Theater</label>
							</div>
						</div>
						<h4>Add Hall</h4>
						<div class="form-group">
							<label for="cinema_rows">Number of rows</label> <input
								type="number" class="form-control" id="cinema_rows" />
						</div>
						<div class="form-group">
							<label for="cinema_columns">Number of columns</label> <input
								type="number" class="form-control" id="cinema_columns" />
						</div>
						<button type="button" class="btn btn-primary"
							id="cinema_hall_add" onclick="cinemaHallAdd()">Add hall</button>
						<div class="form-group">
							<table class="table" id="cinema_halls">
								<thead>
									<tr>
										<th>Rows</th>
										<th>Columns</th>
										<th><br></th>
									</tr>
								</thead>
								<tbody id="cinema_hall_body">
								</tbody>
							</table>
						</div>
						<button class="btn btn-primary" id="cinema_add">Add</button>
					</form>
					<div class="modal-footer">
						<button type="button" class="btn btn-default"
							data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
	check_user();
</script>
</html>